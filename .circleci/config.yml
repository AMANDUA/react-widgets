# Main Config
version: 2.1

# reusable environment for all jobs
executors:
  main-executor:
    working_directory: ~/react-widgets
    docker:
      - image: circleci/node:carbon-browsers


# Reusable commands for jobs
commands:
  restore_workspace:
    steps:
      - attach_workspace:
          at: ~/react-widgets
  restore_node_modules:
    description: 'Restore the node_modules dependencies cache'
    steps:
      - run:
          name: Link cached node_modules to project
          command: mv /tmp/workspace/node_modules ./ || true

jobs:
  install:
    executor: main-executor
    steps:
      - checkout
      - run: echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" >> .npmrc
      - run:
          name: Install dependencies
          command: |
            if [ ! -d node_modules ]; then
              npm install
            fi
      - run:
          name: Copy node_modules to workspace
          command: mv node_modules /tmp/
      - persist_to_workspace:
          root: /tmp
          paths:
            - node_modules
      - run:
          name: Save NPM install log
          command: npm ls --json > /tmp/npm_install.log || true
      - store_artifacts:
          path: /tmp/npm_install.log
          destination: npm-install
  unit_tests_and_linting:
    executor: main-executor
    steps:
      - checkout
      - restore_workspace
      - restore_node_modules
      - run:
          name: Run eslint
          command: npm run eslint -- --format junit -o reports/junit/js-lint-results.xml
      - run:
          name: Run all Jest test suites
          command: npm run jest -- --ci -i --testResultsProcessor="jest-junit"
          environment:
            JEST_JUNIT_OUTPUT: reports/junit/jest/js-jest-results.xml
      - store_test_results:
          path: reports/junit
      - store_artifacts:
          path: reports/junit
          destination: junit

  build_for_tests:
    executor: main-executor
    environment:
      - FEDERATION: "true"
      - NODE_ENV: "test"
      - ACL_SERVICE_URL: "https://acl-intb.ciscospark.com/acl/api/v1"
      - ATLAS_SERVICE_URL: "https://atlas-intb.ciscospark.com/admin/api/v1"
      - CONVERSATION_SERVICE: "https://conversation-intb.ciscospark.com/conversation/api/v1"
      - ENCRYPTION_SERVICE_URL: "https://encryption-intb.ciscospark.com/encryption/api/v1"
      - IDBROKER_BASE_URL: "https://idbrokerbts.webex.com"
      - IDENTITY_BASE_URL: "https://identitybts.webex.com"
      - HYDRA_SERVICE_URL: "https://apialpha.ciscospark.com/v1/"
      - WDM_SERVICE_URL: "https://wdm-intb.ciscospark.com/wdm/api/v1"

    steps:
      - checkout
      - restore_workspace
      - restore_node_modules
      - run:
          name: Copy and build journey test static files
          command: npm run build journey dist-test
      - persist_to_workspace:
          root: ~/react-widgets
          paths:
            - dist-test

  journey_tests_chrome:
    executor: main-executor
    environment:
      SAUCE: true
      STATIC_SERVER_PATH: dist-test
    steps:
      - checkout
      - restore_workspace
      - restore_node_modules
      - run: echo "export BUILD_NUMBER=circle-ci-${CIRCLE_BUILD_NUM}" >> $BASH_ENV
      - run:
          name: Integration Tests Chrome
          no_output_timeout: 15m
          command: |
            set -em
            BROWSER=chrome npm run test:integration
      - store_test_results:
          path: reports/junit/wdio
      - store_artifacts:
          path: reports/junit/wdio
          destination: wdio
      - store_artifacts:
          path: /home/circleci/.npm/_logs/
          destination: npm-logs
      - store_artifacts:
          path: reports/browser
          destination: browser

  journey_tests_firefox:
    executor: main-executor
    environment:
      SAUCE: true
      STATIC_SERVER_PATH: /tmp/workspace/dist-test
    steps:
      - checkout
      - restore_workspace
      - restore_node_modules
      - run: echo "export BUILD_NUMBER=circle-ci-${CIRCLE_BUILD_NUM}" >> $BASH_ENV
      - run:
          name: Integration Tests Firefox
          no_output_timeout: 15m
          command: |
            set -em
            BROWSER=firefox npm run test:integration
      - store_test_results:
          path: reports/junit/wdio
      - store_artifacts:
          path: reports/junit/wdio
          destination: wdio
      - store_artifacts:
          path: /home/circleci/.npm/_logs/
          destination: npm-logs
      - store_artifacts:
          path: reports/browser
          destination: browser

workflows:
  run_all_tests:
    jobs:
      - install
      - build_for_tests:
          requires:
            - install
      - unit_tests_and_linting:
          requires:
            - install
      - journey_tests_chrome:
          requires:
            - build_for_tests
      - journey_tests_firefox:
          requires:
            - journey_tests_chrome
